{"version":3,"sources":["src/server/ProxiedApp.ts"],"names":[],"mappings":"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","file":"ProxiedApp.js","sourcesContent":["import type { IAppAccessors, ILogger } from '../definition/accessors';\nimport type { App } from '../definition/App';\nimport type { AppStatus } from '../definition/AppStatus';\nimport { AppsEngineException } from '../definition/exceptions';\nimport type { IApp } from '../definition/IApp';\nimport type { IAppAuthorInfo, IAppInfo } from '../definition/metadata';\nimport { AppMethod } from '../definition/metadata';\nimport type { AppManager } from './AppManager';\nimport { NotEnoughMethodArgumentsError } from './errors';\nimport { InvalidInstallationError } from './errors/InvalidInstallationError';\nimport { AppConsole } from './logging';\nimport { AppLicenseValidationResult } from './marketplace/license';\nimport type { AppsEngineRuntime } from './runtime/AppsEngineRuntime';\nimport type { IAppStorageItem } from './storage';\n\nexport class ProxiedApp implements IApp {\n    private previousStatus: AppStatus;\n\n    private latestLicenseValidationResult: AppLicenseValidationResult;\n\n    constructor(\n        private readonly manager: AppManager,\n        private storageItem: IAppStorageItem,\n        private readonly app: App,\n        private readonly runtime: AppsEngineRuntime,\n    ) {\n        this.previousStatus = storageItem.status;\n    }\n\n    public getRuntime(): AppsEngineRuntime {\n        return this.runtime;\n    }\n\n    public getApp(): App {\n        return this.app;\n    }\n\n    public getStorageItem(): IAppStorageItem {\n        return this.storageItem;\n    }\n\n    public setStorageItem(item: IAppStorageItem): void {\n        this.storageItem = item;\n    }\n\n    public getPreviousStatus(): AppStatus {\n        return this.previousStatus;\n    }\n\n    public getImplementationList(): { [inter: string]: boolean } {\n        return this.storageItem.implemented;\n    }\n\n    public hasMethod(method: AppMethod): boolean {\n        return typeof (this.app as any)[method] === 'function';\n    }\n\n    public setupLogger(method: `${AppMethod}`): AppConsole {\n        const logger = new AppConsole(method);\n        // Set the logger to our new one\n        (this.app as any).logger = logger;\n\n        return logger;\n    }\n\n    public async call(method: `${AppMethod}`, ...args: Array<any>): Promise<any> {\n        if (typeof (this.app as any)[method] !== 'function') {\n            throw new Error(`The App ${this.app.getName()} (${this.app.getID()} does not have the method: \"${method}\"`);\n        }\n\n        const methodDeclartion = (this.app as any)[method] as (...args: any[]) => any;\n        if (args.length < methodDeclartion.length) {\n            throw new NotEnoughMethodArgumentsError(method, methodDeclartion.length, args.length);\n        }\n\n        const logger = this.setupLogger(method);\n        logger.debug(`${method} is being called...`);\n\n        let result;\n        try {\n            result = await this.runtime.runInSandbox(`module.exports = app.${method}.apply(app, args)`, { app: this.app, args });\n            logger.debug(`'${method}' was successfully called! The result is:`, result);\n        } catch (e) {\n            logger.error(e);\n            logger.debug(`'${method}' was unsuccessful.`);\n\n            const errorInfo = new AppsEngineException(e.message).getErrorInfo();\n            if (e.name === errorInfo.name) {\n                throw e;\n            }\n        } finally {\n            await this.manager.getLogStorage().storeEntries(this.getID(), logger);\n        }\n\n        return result;\n    }\n\n    public getStatus(): AppStatus {\n        return this.app.getStatus();\n    }\n\n    public async setStatus(status: AppStatus, silent?: boolean): Promise<void> {\n        await this.call(AppMethod.SETSTATUS, status);\n\n        if (!silent) {\n            await this.manager.getBridges().getAppActivationBridge().doAppStatusChanged(this, status);\n        }\n    }\n\n    public getName(): string {\n        return this.app.getName();\n    }\n\n    public getNameSlug(): string {\n        return this.app.getNameSlug();\n    }\n\n    public getAppUserUsername(): string {\n        return this.app.getAppUserUsername();\n    }\n\n    public getID(): string {\n        return this.app.getID();\n    }\n\n    public getVersion(): string {\n        return this.app.getVersion();\n    }\n\n    public getDescription(): string {\n        return this.app.getDescription();\n    }\n\n    public getRequiredApiVersion(): string {\n        return this.app.getRequiredApiVersion();\n    }\n\n    public getAuthorInfo(): IAppAuthorInfo {\n        return this.app.getAuthorInfo();\n    }\n\n    public getInfo(): IAppInfo {\n        return this.app.getInfo();\n    }\n\n    public getLogger(): ILogger {\n        return this.app.getLogger();\n    }\n\n    public getAccessors(): IAppAccessors {\n        return this.app.getAccessors();\n    }\n\n    public getEssentials(): IAppInfo['essentials'] {\n        return this.getInfo().essentials;\n    }\n\n    public getLatestLicenseValidationResult(): AppLicenseValidationResult {\n        return this.latestLicenseValidationResult;\n    }\n\n    public async validateInstallation(): Promise<void> {\n        try {\n            await this.manager.getSignatureManager().verifySignedApp(this.getStorageItem());\n        } catch (e) {\n            throw new InvalidInstallationError(e.message);\n        }\n    }\n\n    public validateLicense(): Promise<void> {\n        const { marketplaceInfo } = this.getStorageItem();\n\n        this.latestLicenseValidationResult = new AppLicenseValidationResult();\n\n        return this.manager.getLicenseManager().validate(this.latestLicenseValidationResult, marketplaceInfo);\n    }\n}\n"]}